version: '2'

volumes:
  mongo-data:
    driver: local
  redis-data:
    driver: local

services:
  mongo:
    image: mongo:latest
    # restart: always
    volumes:
      - mongo-data:/data
    ports:
      - "27017:27017"
  redis:
    image: redis:alpine
    # restart: always
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
  vscode:
    image: registry.cn-hangzhou.aliyuncs.com/wangdong/vscode:latest
    # restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - .:/home/vscode/workspace
    command: --allow-http --no-auth --disable-telemetry
  nginx:
    image: nginx:alpine
    # restart: always
    environment:
      NGINX_CONFIG: |
        server {
          listen      80 default_server;
          server_name localhost;
          location / {
            proxy_pass        http://vscode:8443;
            proxy_set_header  Host $$host;
            proxy_set_header  X-Real-IP $$remote_addr;
            proxy_set_header  X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header  Upgrade $$http_upgrade;
            proxy_set_header  Connection "upgrade";

            set_real_ip_from  172.0.0.0/8;
            set_real_ip_from  10.0.0.0/8;
            real_ip_header    X-Forwarded-For;
            real_ip_recursive on;
          }
        }
    command: /bin/sh -c 'echo "$$NGINX_CONFIG" > /etc/nginx/conf.d/default.conf && exec nginx -g "daemon off;"'
    ports:
      - "80:80"
